<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bast√≥n Inteligente</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box}body{font-family:system-ui,sans-serif;background:linear-gradient(135deg,#667eea,#764ba2);min-height:100vh;padding:20px;color:#333}.container{max-width:600px;margin:0 auto}.card{background:#fff;border-radius:20px;padding:25px;margin-bottom:20px;box-shadow:0 10px 30px rgba(0,0,0,.2)}h1{color:#667eea;text-align:center;margin-bottom:10px;font-size:28px}.subtitle{text-align:center;color:#666;margin-bottom:20px;font-size:14px}.status{padding:15px;border-radius:10px;text-align:center;font-weight:600;margin-bottom:20px}.status.disconnected{background:#fee;color:#c33}.status.connected{background:#efe;color:#3c3}.status.searching{background:#fef3cd;color:#856404}button{width:100%;padding:15px;border:none;border-radius:10px;font-size:16px;font-weight:600;cursor:pointer;margin-bottom:10px}.btn-primary{background:#667eea;color:#fff}.btn-danger{background:#ef4444;color:#fff}.btn-test{background:#f59e0b;color:#fff;padding:10px;font-size:14px}.info-box{background:#f8f9fa;border-left:4px solid #667eea;padding:15px;border-radius:5px;margin-bottom:15px}.log{background:#1e1e1e;color:#d4d4d4;border-radius:10px;padding:15px;max-height:300px;overflow-y:auto;font-family:monospace;font-size:12px}.log-entry{margin-bottom:5px}.log-info{color:#4fc3f7}.log-success{color:#66bb6a;font-weight:600}.log-error{color:#ef5350;font-weight:600}.log-warn{color:#ffb74d}.spinner{border:3px solid #f3f3f3;border-top:3px solid #667eea;border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin:10px auto;display:none}@keyframes spin{to{transform:rotate(360deg)}}.current-step{background:#fffbeb;border-left:4px solid #f59e0b;padding:20px;border-radius:5px;display:none}.distance-badge{display:inline-block;background:#f59e0b;color:#fff;padding:5px 15px;border-radius:20px;font-size:18px;font-weight:700;margin-bottom:10px}.instruction-text{font-size:20px;font-weight:600;color:#333;line-height:1.4}
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>ü¶Ø Bast√≥n Inteligente</h1>
            <p class="subtitle">Audio TTS por BLE ‚Ä¢ v4.0 Final</p>
            <div id="status" class="status disconnected">‚ùå Desconectado</div>
            <button id="connectBtn" class="btn-primary">üì° Conectar</button>
            <button id="disconnectBtn" class="btn-danger" style="display:none">üîå Desconectar</button>
            <button id="testBtn" class="btn-test">üß™ Test: Plaza Mayor</button>
            <div class="spinner" id="spinner"></div>
            <div id="destinationInfo" class="info-box" style="display:none">
                <strong>üìç Destino:</strong> <span id="destinationText">---</span>
            </div>
            <div id="currentStep" class="current-step">
                <div class="distance-badge" id="stepDistance">---</div>
                <div class="instruction-text" id="stepInstruction">---</div>
                <div style="margin-top:10px;font-size:14px;color:#666">
                    Paso <span id="stepNumber">1</span>/<span id="totalSteps">0</span> ‚Ä¢ 
                    Pr√≥ximo en <span id="timeRemaining">--</span>s
                </div>
            </div>
        </div>
        <div class="card">
            <h3 style="margin-bottom:15px;color:#667eea">üìã Log</h3>
            <div id="log" class="log"></div>
        </div>
    </div>
    <script>
        const SVC='4fafc201-1fb5-459e-8fcc-c5c9c331914b',NFC='beb5483e-36e1-4688-b7f5-ea07361b26a8',AUD='1c95d5e3-d8f7-413a-bf3d-7a2e5d7be87e',RTE='d8de624e-140f-4a3e-a5f0-7de3f3f5e5e5',KEY='bd217cf3-7956-4b37-a7e0-7bf82a391e5a';
        let dev,nfc,aud,rte,ins=[],idx=0,ctx;
        const $=i=>document.getElementById(i),log=(m,t='info')=>{console.log(`[${t}]`,m);const e=document.createElement('div');e.className=`log-entry log-${t}`;e.textContent=`[${new Date().toLocaleTimeString()}] ${m}`;$('log').insertBefore(e,$('log').firstChild)},st=(t,c)=>{$('status').textContent=t;$('status').className=`status ${c}`},fd=m=>m<1000?`${Math.round(m)}m`:`${(m/1e3).toFixed(1)}km`,gd=s=>({0:'contin√∫a recto',1:'gira ligeramente a la derecha',2:'gira a la derecha',3:'gira fuertemente a la derecha','-1':'gira ligeramente a la izquierda','-2':'gira a la izquierda','-3':'gira fuertemente a la izquierda',4:'has llegado',5:'has llegado',6:'toma la rotonda'}[s]||'contin√∫a');
        
        async function tts2audio(txt){
            if(!ctx)ctx=new(window.AudioContext||window.webkitAudioContext)({sampleRate:16000});
            return new Promise(res=>{
                const u=new SpeechSynthesisUtterance(txt);
                u.lang='es-ES';u.rate=.85;u.pitch=1;
                const md=navigator.mediaDevices,dest=ctx.createMediaStreamDestination();
                md.getUserMedia({audio:true}).then(()=>{
                    const osc=ctx.createOscillator();osc.connect(dest);osc.start();
                    window.speechSynthesis.speak(u);
                    const rec=new MediaRecorder(dest.stream);
                    const chunks=[];
                    rec.ondataavailable=e=>chunks.push(e.data);
                    rec.onstop=async()=>{
                        const blob=new Blob(chunks,{type:'audio/webm'});
                        const ab=await blob.arrayBuffer();
                        const pcm=await ctx.decodeAudioData(ab);
                        const data=pcm.getChannelData(0);
                        const int16=new Int16Array(data.length);
                        for(let i=0;i<data.length;i++)int16[i]=Math.max(-32768,Math.min(32767,data[i]*32767));
                        res({audio:int16,dur:pcm.duration*1e3});
                    };
                    rec.start();
                    u.onend=()=>{setTimeout(()=>rec.stop(),500);osc.stop()};
                }).catch(()=>{
                    const wc=txt.split(' ').length;
                    res({audio:new Int16Array(0),dur:wc*600});
                });
            });
        }
        
        async function sendAudio(txt){
            if(!aud||!dev?.gatt?.connected){
                log('Sin BLE, reproduciendo local','warn');
                const u=new SpeechSynthesisUtterance(txt);
                u.lang='es-ES';u.rate=.85;
                return new Promise(r=>{u.onend=r;window.speechSynthesis.speak(u)});
            }
            try{
                log(`üîä Generando TTS: "${txt.substring(0,30)}..."`,'info');
                const {audio,dur}=await tts2audio(txt);
                if(audio.length===0){
                    log('‚ö†Ô∏è Fallback: TTS local','warn');
                    const u=new SpeechSynthesisUtterance(txt);
                    u.lang='es-ES';u.rate=.85;
                    return new Promise(r=>{u.onend=r;window.speechSynthesis.speak(u)});
                }
                log(`üì§ Enviando ${audio.length} samples (${(audio.length*2/1024).toFixed(1)}KB)`,'info');
                const buf=audio.buffer;
                const chunk=512;
                for(let i=0;i<buf.byteLength;i+=chunk){
                    const slice=buf.slice(i,Math.min(i+chunk,buf.byteLength));
                    await aud.writeValue(slice);
                    await new Promise(r=>setTimeout(r,30));
                }
                log('‚úì Audio enviado','success');
                return new Promise(r=>setTimeout(r,dur));
            }catch(e){
                log(`‚ùå ${e.message}`,'error');
                const u=new SpeechSynthesisUtterance(txt);
                u.lang='es-ES';u.rate=.85;
                return new Promise(r=>{u.onend=r;window.speechSynthesis.speak(u)});
            }
        }
        
        async function conn(){
            try{
                if(!navigator.bluetooth)throw new Error('Bluetooth no disponible');
                st('üîç Buscando...','searching');
                $('spinner').style.display='block';
                dev=await navigator.bluetooth.requestDevice({filters:[{name:'BastonInteligente'}],optionalServices:[SVC]});
                const srv=await dev.gatt.connect();
                const svc=await srv.getPrimaryService(SVC);
                nfc=await svc.getCharacteristic(NFC);
                aud=await svc.getCharacteristic(AUD);
                rte=await svc.getCharacteristic(RTE);
                await nfc.startNotifications();
                nfc.addEventListener('characteristicvaluechanged',e=>{
                    const d=new TextDecoder().decode(e.target.value).replace(/\0/g,'').trim();
                    log(`üì° NFC: ${d}`,'success');
                    $('destinationText').textContent=d;
                    $('destinationInfo').style.display='block';
                    route(d);
                });
                st('‚úÖ Conectado','connected');
                $('connectBtn').style.display='none';
                $('disconnectBtn').style.display='block';
                $('spinner').style.display='none';
                log('‚úÖ Listo','success');
                await sendAudio('Sistema conectado');
            }catch(e){
                log(`‚ùå ${e.message}`,'error');
                st('‚ùå Error','disconnected');
                $('spinner').style.display='none';
            }
        }
        
        async function route(dest){
            try{
                $('spinner').style.display='block';
                const pos=await new Promise((y,n)=>navigator.geolocation.getCurrentPosition(y,n,{enableHighAccuracy:1,timeout:1e4}));
                const la=pos.coords.latitude,lo=pos.coords.longitude;
                log(`GPS: ${la.toFixed(4)},${lo.toFixed(4)}`,'success');
                const gr=await fetch(`https://graphhopper.com/api/1/geocode?q=${encodeURIComponent(dest)}&locale=es&limit=1&key=${KEY}`);
                const gd=await gr.json();
                if(!gd.hits?.length)throw new Error('Destino no encontrado');
                const tla=gd.hits[0].point.lat,tlo=gd.hits[0].point.lng;
                log(`Destino: ${gd.hits[0].name||dest}`,'success');
                const rr=await fetch(`https://graphhopper.com/api/1/route?point=${la},${lo}&point=${tla},${tlo}&profile=foot&locale=es&instructions=true&points_encoded=false&key=${KEY}`);
                const rd=await rr.json();
                if(!rd.paths?.length)throw new Error('Sin rutas');
                const p=rd.paths[0],di=p.distance,du=p.time/1e3;
                log(`‚úì ${fd(di)}, ${Math.round(du/60)}min`,'success');
                if(rte)await rte.writeValue(new TextEncoder().encode('1'));
                proc(p.instructions,di,du);
                $('spinner').style.display='none';
            }catch(e){
                log(`‚ùå ${e.message}`,'error');
                $('spinner').style.display='none';
                await sendAudio(`Error: ${e.message}`);
            }
        }
        
        function proc(ist,td,tdu){
            ins=[];
            ins.push({text:`Ruta calculada. Distancia: ${fd(td)}. Duraci√≥n: ${Math.round(tdu/60)} minutos. Comenzamos.`,dist:0,time:5e3});
            ist.forEach((i,n)=>{
                if(i.sign===4||i.sign===5){
                    ins.push({text:'Has llegado a tu destino',dist:0,time:3e3});
                }else{
                    const d=gd(i.sign),ds=fd(i.distance),t=n===0?`Comienza: ${d} durante ${ds}`:`${d.charAt(0).toUpperCase()+d.slice(1)} en ${ds}`,wt=(i.distance/1.4)*1e3;
                    ins.push({text:t,dist:i.distance,time:Math.max(wt,5e3)});
                }
            });
            $('totalSteps').textContent=ins.length;
            $('currentStep').style.display='block';
            log(`‚úì ${ins.length} pasos`,'success');
            idx=0;
            play();
        }
        
        async function play(){
            if(idx>=ins.length){
                log('üéâ Completado','success');
                $('stepInstruction').textContent='‚úÖ Has llegado';
                $('stepDistance').textContent='0m';
                await sendAudio('Has llegado a tu destino');
                return;
            }
            const s=ins[idx];
            $('stepNumber').textContent=idx+1;
            $('stepInstruction').textContent=s.text;
            $('stepDistance').textContent=s.dist>0?fd(s.dist):'---';
            log(`üì¢ ${idx+1}/${ins.length}: ${s.text}`,'info');
            await sendAudio(s.text);
            idx++;
            const wt=s.time;
            let rm=Math.round(wt/1e3);
            $('timeRemaining').textContent=rm;
            log(`‚è±Ô∏è Esperando ${rm}s`,'warn');
            const iv=setInterval(()=>{rm--;$('timeRemaining').textContent=rm;if(rm<=0)clearInterval(iv)},1e3);
            setTimeout(play,wt);
        }
        
        $('connectBtn').onclick=conn;
        $('disconnectBtn').onclick=()=>{if(dev?.gatt?.connected)dev.gatt.disconnect();st('‚ùå Desconectado','disconnected');$('connectBtn').style.display='block';$('disconnectBtn').style.display='none'};
        $('testBtn').onclick=()=>{log('üß™ Test','warn');$('destinationText').textContent='Plaza Mayor Madrid';$('destinationInfo').style.display='block';route('Plaza Mayor Madrid')};
        log('‚úÖ App v4.0 cargada','success');
    </script>
</body>
</html>
