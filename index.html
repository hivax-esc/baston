<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#1a73e8">
    <title>Bast√≥n Inteligente</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        h1 {
            color: #667eea;
            text-align: center;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            background: #10b981;
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 20px;
            transition: all 0.3s;
        }

        .status.disconnected {
            background: #fee;
            color: #c33;
        }

        .status.connected {
            background: #efe;
            color: #3c3;
        }

        .status.searching {
            background: #fef3cd;
            color: #856404;
        }

        button {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-test {
            background: #f59e0b;
            color: white;
            font-size: 14px;
            padding: 10px;
        }

        .info-box {
            background: #f8f9fa;
            border-left: 4px solid #667eea;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .info-box strong {
            color: #667eea;
            display: block;
            margin-bottom: 5px;
        }

        .log {
            background: #1e1e1e;
            color: #d4d4d4;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            line-height: 1.6;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }

        .log-info {
            color: #4fc3f7;
        }

        .log-success {
            color: #66bb6a;
            font-weight: 600;
        }

        .log-error {
            color: #ef5350;
            font-weight: 600;
        }

        .log-warn {
            color: #ffb74d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .route-info {
            background: #f0fdf4;
            border-left: 4px solid #10b981;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .current-step {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }

        .current-step .distance-badge {
            display: inline-block;
            background: #f59e0b;
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .current-step .instruction-text {
            font-size: 20px;
            font-weight: 600;
            color: #333;
            line-height: 1.4;
        }

        .icon {
            font-size: 40px;
            text-align: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <div class="icon">ü¶Ø</div>
            <h1>Bast√≥n Inteligente <span class="badge">GRATIS</span></h1>
            <p class="subtitle">Sistema de navegaci√≥n asistida</p>
            
            <div id="status" class="status disconnected">
                ‚ùå Desconectado
            </div>

            <button id="connectBtn" class="btn-primary">
                üì° Conectar al Bast√≥n
            </button>

            <button id="disconnectBtn" class="btn-danger" style="display:none;">
                üîå Desconectar
            </button>

            <button id="testBtn" class="btn-test">
                üß™ Test Simulado (sin BLE)
            </button>

            <div class="spinner" id="spinner"></div>

            <div id="destinationInfo" class="info-box" style="display:none;">
                <strong>üìç Destino:</strong>
                <span id="destinationText">---</span>
            </div>

            <div id="routeInfo" class="route-info">
                <strong>üó∫Ô∏è Ruta: <span id="routeDistance">---</span> ‚Ä¢ <span id="routeDuration">---</span></strong>
            </div>

            <div id="currentStep" class="current-step">
                <div class="distance-badge" id="stepDistance">---</div>
                <div class="instruction-text" id="stepInstruction">---</div>
                <div style="margin-top: 10px; font-size: 14px; color: #666;">
                    Paso <span id="stepNumber">1</span> de <span id="totalSteps">0</span>
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-bottom: 15px; color: #667eea;">üìã Console Log</h3>
            <div id="log" class="log">
                <div class="log-entry log-info">Iniciando aplicaci√≥n...</div>
            </div>
        </div>
    </div>

    <script>
        console.log('Script iniciado');

        // UUIDs BLE
        const SERVICE_UUID = '4fafc201-1fb5-459e-8fcc-c5c9c331914b';
        const NFC_CHAR_UUID = 'beb5483e-36e1-4688-b7f5-ea07361b26a8';
        const ROUTE_CHAR_UUID = 'd8de624e-140f-4a3e-a5f0-7de3f3f5e5e5';

        // GraphHopper API
        const GRAPHHOPPER_KEY = '5d8ba72b-ab2a-4545-a5a7-3f9596a55296';

        let device = null;
        let nfcCharacteristic = null;
        let routeCharacteristic = null;
        let currentInstructions = [];
        let instructionIndex = 0;

        // DOM Elements
        const statusEl = document.getElementById('status');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const testBtn = document.getElementById('testBtn');
        const logEl = document.getElementById('log');
        const spinnerEl = document.getElementById('spinner');
        const destinationInfoEl = document.getElementById('destinationInfo');
        const destinationTextEl = document.getElementById('destinationText');
        const routeInfoEl = document.getElementById('routeInfo');
        const routeDistanceEl = document.getElementById('routeDistance');
        const routeDurationEl = document.getElementById('routeDuration');
        const currentStepEl = document.getElementById('currentStep');
        const stepDistanceEl = document.getElementById('stepDistance');
        const stepInstructionEl = document.getElementById('stepInstruction');
        const stepNumberEl = document.getElementById('stepNumber');
        const totalStepsEl = document.getElementById('totalSteps');

        function log(message, type = 'info') {
            console.log(`[${type}] ${message}`);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
        }

        function updateStatus(text, state) {
            statusEl.textContent = text;
            statusEl.className = `status ${state}`;
        }

        function speak(text) {
            return new Promise((resolve) => {
                try {
                    if ('speechSynthesis' in window) {
                        window.speechSynthesis.cancel();
                        const utterance = new SpeechSynthesisUtterance(text);
                        utterance.lang = 'es-ES';
                        utterance.rate = 0.85;
                        utterance.pitch = 1.0;
                        utterance.volume = 1.0;
                        utterance.onend = resolve;
                        utterance.onerror = resolve;
                        window.speechSynthesis.speak(utterance);
                    } else {
                        log('TTS no disponible', 'warn');
                        resolve();
                    }
                } catch (err) {
                    log(`Error TTS: ${err.message}`, 'error');
                    resolve();
                }
            });
        }

        function formatDistance(meters) {
            if (meters < 50) {
                return `${Math.round(meters / 10) * 10} metros`;
            } else if (meters < 1000) {
                return `${Math.round(meters / 50) * 50} metros`;
            } else {
                return `${(meters / 1000).toFixed(1)} kil√≥metros`;
            }
        }

        function getDirectionText(sign) {
            const directions = {
                0: 'contin√∫a recto',
                1: 'gira ligeramente a la derecha',
                2: 'gira a la derecha',
                3: 'gira fuertemente a la derecha',
                '-1': 'gira ligeramente a la izquierda',
                '-2': 'gira a la izquierda',
                '-3': 'gira fuertemente a la izquierda',
                4: 'has llegado',
                5: 'has llegado',
                6: 'toma la rotonda'
            };
            return directions[sign] || 'contin√∫a';
        }

        async function connectBLE() {
            try {
                log('Iniciando conexi√≥n BLE...', 'info');
                
                if (!navigator.bluetooth) {
                    throw new Error('Bluetooth no disponible. Usa Chrome en Android.');
                }

                updateStatus('üîç Buscando...', 'searching');
                spinnerEl.style.display = 'block';

                device = await navigator.bluetooth.requestDevice({
                    filters: [{ name: 'BastonInteligente' }],
                    optionalServices: [SERVICE_UUID]
                });

                log(`Dispositivo encontrado: ${device.name}`, 'success');

                const server = await device.gatt.connect();
                log('Conectado a GATT', 'success');

                const service = await server.getPrimaryService(SERVICE_UUID);
                log('Servicio obtenido', 'success');

                nfcCharacteristic = await service.getCharacteristic(NFC_CHAR_UUID);
                routeCharacteristic = await service.getCharacteristic(ROUTE_CHAR_UUID);
                
                await nfcCharacteristic.startNotifications();
                nfcCharacteristic.addEventListener('characteristicvaluechanged', handleNfcData);

                updateStatus('‚úÖ Conectado', 'connected');
                connectBtn.style.display = 'none';
                disconnectBtn.style.display = 'block';
                spinnerEl.style.display = 'none';

                log('Sistema listo', 'success');
                speak('Conectado. Sistema listo.');

            } catch (error) {
                log(`Error BLE: ${error.message}`, 'error');
                console.error('Error completo:', error);
                updateStatus('‚ùå Error', 'disconnected');
                spinnerEl.style.display = 'none';
                alert(`Error: ${error.message}`);
            }
        }

        function handleNfcData(event) {
            try {
                const value = event.target.value;
                const decoder = new TextDecoder('utf-8');
                const destination = decoder.decode(value).replace(/\0/g, '').trim();

                log(`Destino NFC: ${destination}`, 'success');
                destinationTextEl.textContent = destination;
                destinationInfoEl.style.display = 'block';

                speak(`Destino: ${destination}`);
                searchRoute(destination);
            } catch (error) {
                log(`Error leyendo NFC: ${error.message}`, 'error');
            }
        }

        async function searchRoute(destination) {
            try {
                spinnerEl.style.display = 'block';
                log('Buscando ruta...', 'info');

                // Ubicaci√≥n
                log('Obteniendo GPS...', 'info');
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });

                const fromLat = position.coords.latitude;
                const fromLon = position.coords.longitude;
                log(`GPS: ${fromLat.toFixed(4)}, ${fromLon.toFixed(4)}`, 'success');

                // Geocodificar
                log('Geocodificando...', 'info');
                const geocodeUrl = `https://graphhopper.com/api/1/geocode?q=${encodeURIComponent(destination)}&locale=es&limit=1&key=${GRAPHHOPPER_KEY}`;
                
                const geocodeRes = await fetch(geocodeUrl);
                if (!geocodeRes.ok) throw new Error('Geocoding fall√≥');
                
                const geocodeData = await geocodeRes.json();
                if (!geocodeData.hits || geocodeData.hits.length === 0) {
                    throw new Error('Destino no encontrado');
                }

                const toLat = geocodeData.hits[0].point.lat;
                const toLon = geocodeData.hits[0].point.lng;
                log(`Destino: ${toLat.toFixed(4)}, ${toLon.toFixed(4)}`, 'success');

                // Ruta
                log('Calculando ruta...', 'info');
                const routeUrl = `https://graphhopper.com/api/1/route?point=${fromLat},${fromLon}&point=${toLat},${toLon}&vehicle=foot&locale=es&instructions=true&points_encoded=false&key=${GRAPHHOPPER_KEY}`;
                
                const routeRes = await fetch(routeUrl);
                if (!routeRes.ok) throw new Error('Routing fall√≥');
                
                const routeData = await routeRes.json();
                if (!routeData.paths || routeData.paths.length === 0) {
                    throw new Error('Sin rutas');
                }

                const path = routeData.paths[0];
                const distance = path.distance;
                const duration = path.time / 1000;

                log(`Ruta: ${(distance/1000).toFixed(2)} km, ${Math.round(duration/60)} min`, 'success');

                routeDistanceEl.textContent = distance >= 1000 ? `${(distance/1000).toFixed(2)} km` : `${Math.round(distance)} m`;
                routeDurationEl.textContent = `${Math.round(duration/60)} min`;
                routeInfoEl.style.display = 'block';

                if (routeCharacteristic) {
                    await routeCharacteristic.writeValue(new TextEncoder().encode('1'));
                }

                processInstructions(path.instructions, distance, duration);
                spinnerEl.style.display = 'none';

            } catch (error) {
                log(`Error: ${error.message}`, 'error');
                console.error(error);
                spinnerEl.style.display = 'none';
                speak(`Error: ${error.message}`);
            }
        }

        function processInstructions(instructions, totalDist, totalDur) {
            currentInstructions = [];

            const intro = `Ruta calculada. Distancia: ${formatDistance(totalDist)}. Duraci√≥n: ${Math.round(totalDur/60)} minutos. Comenzamos.`;
            currentInstructions.push({ text: intro, distance: 0 });

            instructions.forEach((instr, i) => {
                if (instr.sign === 4 || instr.sign === 5) {
                    currentInstructions.push({ text: 'Has llegado', distance: 0 });
                } else {
                    const dir = getDirectionText(instr.sign);
                    const dist = formatDistance(instr.distance);
                    const text = i === 0 ? `Comienza: ${dir} durante ${dist}` : `${dir.charAt(0).toUpperCase() + dir.slice(1)} en ${dist}`;
                    currentInstructions.push({ text, distance: instr.distance });
                }
            });

            totalStepsEl.textContent = currentInstructions.length;
            log(`${currentInstructions.length} pasos`, 'success');
            
            currentStepEl.style.display = 'block';
            instructionIndex = 0;
            playNextInstruction();
        }

        async function playNextInstruction() {
            if (instructionIndex >= currentInstructions.length) {
                log('Navegaci√≥n completa', 'success');
                stepInstructionEl.textContent = '‚úÖ Llegaste';
                speak('Has llegado');
                return;
            }

            const step = currentInstructions[instructionIndex];
            stepNumberEl.textContent = instructionIndex + 1;
            stepInstructionEl.textContent = step.text;
            stepDistanceEl.textContent = step.distance > 0 ? formatDistance(step.distance) : '---';

            log(`üîä ${step.text}`, 'info');
            await speak(step.text);
            
            instructionIndex++;
            setTimeout(playNextInstruction, 1500);
        }

        function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            }
            updateStatus('‚ùå Desconectado', 'disconnected');
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
            log('Desconectado', 'info');
        }

        // TEST MODE
        testBtn.addEventListener('click', () => {
            log('Modo test activado', 'warn');
            destinationTextEl.textContent = 'Plaza Mayor Madrid';
            destinationInfoEl.style.display = 'block';
            searchRoute('Plaza Mayor Madrid');
        });

        connectBtn.addEventListener('click', connectBLE);
        disconnectBtn.addEventListener('click', disconnect);

        // Inicializaci√≥n
        log('App cargada correctamente', 'success');
        log('Versi√≥n: 2.0 - GraphHopper', 'info');
        
        if (!navigator.bluetooth) {
            log('‚ö†Ô∏è Bluetooth no disponible. Usa Chrome Android.', 'warn');
        }
    </script>
</body>
</html>
